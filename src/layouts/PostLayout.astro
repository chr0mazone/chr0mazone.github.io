---
import BaseLayout from './BaseLayout.astro';
import Badge from '../components/Badge.astro';
import { CollapsiblePanel } from '../components/ui/collapsible';
import { List, Home, FileText, ChevronLeft } from '@lucide/astro';

interface Props {
  title: string;
  description?: string;
  date: Date;
  tags?: string[];
  image?: string;
  parentSlug: string;
  currentSlug: string;
  subposts: Array<{ slug: string; title: string; href: string }>;
  readingTime: number;
}

const { title, description, date, tags = [], image, parentSlug, subposts, readingTime } = Astro.props;

const formattedDate = date.toLocaleDateString('en-US', {
  month: 'long', day: 'numeric', year: 'numeric'
});
---

<BaseLayout title={title} description={description}>
  <div class="post-page-layout">

    <!-- Left sidebar: TOC (desktop only) -->
    <aside class="post-left-sidebar">
      <div class="sidebar-panel">
        <div class="sidebar-section-title">
          <List size={13} stroke-width={3} aria-hidden="true" />
          ON THIS PAGE
        </div>
        <nav id="toc">
          <ul class="toc-list" id="toc-list"></ul>
        </nav>
      </div>
    </aside>

    <!-- Main content -->
    <main class="post-content">

      <!-- Mobile collapsible sidebars -->
      <div class="post-mobile-sidebars">
        {subposts.length > 0 && (
          <CollapsiblePanel label="SECTIONS" client:load>
            <ul class="subpost-list" style="padding: 0.25rem 0;">
              {subposts.map(sp => (
                <li class:list={['subpost-item', sp.slug === 'index' && 'is-index']}>
                  <a href={sp.href} aria-current={sp.href === Astro.url.pathname ? 'page' : undefined}>
                    {sp.slug === 'index'
                      ? <Home size={12} stroke-width={2} aria-hidden="true" />
                      : <FileText size={12} stroke-width={2} aria-hidden="true" />
                    }
                    {sp.title}
                  </a>
                </li>
              ))}
            </ul>
          </CollapsiblePanel>
        )}
        <!-- Mobile TOC injected by script below -->
        <div id="mobile-toc-wrapper"></div>
      </div>

      <!-- Post header -->
      <header class="post-header">
        {image && (
          <div class="post-header-image-wrap">
            <img src={image} alt={title} class="post-header-image" />
          </div>
        )}
        <div class="post-header-meta">
          <a href="/blog" style="color:var(--text-muted); display:flex; align-items:center; gap:0.3rem;">
            <ChevronLeft size={13} stroke-width={2} aria-hidden="true" />
            blog
          </a>
          <span>/</span>
          <span>{parentSlug}</span>
          <!-- <span style="margin-left:auto;">{formattedDate}</span>
          <span style="color:var(--color-tip);">{readingTime} min read</span> -->
          <span class="post-header-meta-right">
            <span>{formattedDate}</span>
            <span class="read-time">{readingTime} min read</span>
          </span>
        </div>
        <h1 class="post-header-title">{title}</h1>
        {description && <p class="post-header-desc">{description}</p>}
        {tags.length > 0 && (
          <div class="post-header-tags">
            {tags.map(tag => <Badge tag={tag} />)}
          </div>
        )}
      </header>

      <div class="prose"><slot /></div>
    </main>

    <!-- Right sidebar: subpost nav (desktop only) -->
    {subposts.length > 0 && (
      <aside class="post-right-sidebar">
        <div class="sidebar-panel">
          <div class="sidebar-section-title">
            <FileText size={13} stroke-width={2} aria-hidden="true" />
            SECTIONS
          </div>
          <ul class="subpost-list">
            {subposts.map(sp => (
              <li class:list={['subpost-item', sp.slug === 'index' && 'is-index']}>
                <a href={sp.href} aria-current={sp.href === Astro.url.pathname ? 'page' : undefined}>
                  {sp.slug === 'index'
                    ? <Home size={12} stroke-width={2} aria-hidden="true" />
                    : <FileText size={12} stroke-width={2} aria-hidden="true" />
                  }
                  {sp.title}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </aside>
    )}

  </div>
</BaseLayout>

<script>
  import { createElement } from 'react';
  import { createRoot } from 'react-dom/client';
  import { CollapsiblePanel } from '@/components/ui/collapsible';

  function buildTOC() {
    const prose = document.querySelector('.prose');
    if (!prose) return;

    const headings = Array.from(prose.querySelectorAll('h2, h3, h4'));
    headings.forEach(h => {
      if (!h.id) {
        h.id = h.textContent?.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '') ?? '';
      }
    });
    if (headings.length === 0) return;

    // Desktop TOC
    const tocList = document.getElementById('toc-list');
    if (tocList) {
      tocList.innerHTML = headings.map(h => {
        const depth = parseInt(h.tagName[1]);
        return `<li class="toc-item depth-${depth}"><a href="#${h.id}">${h.textContent}</a></li>`;
      }).join('');
    }

    // Mobile TOC via React
    const wrapper = document.getElementById('mobile-toc-wrapper');
    if (wrapper) {
      const items = headings.map(h =>
        createElement('li', {
          key: h.id,
          className: `toc-item depth-${parseInt(h.tagName[1])}`,
        },
          createElement('a', { href: `#${h.id}` }, h.textContent)
        )
      );
      const panel = createElement(
        CollapsiblePanel,
        { label: 'ON THIS PAGE' },
        createElement('ul', { className: 'toc-list', style: { padding: '0.25rem 0' } }, ...items)
      );
      createRoot(wrapper).render(panel);
    }

    // Active heading observer
    const items = tocList?.querySelectorAll('.toc-item') ?? [];
    const itemMap = new Map<string, Element>();
    items.forEach(item => {
      const id = item.querySelector('a')?.getAttribute('href')?.slice(1);
      if (id) itemMap.set(id, item);
    });
    const observer = new IntersectionObserver(entries => {
      entries.forEach(e => itemMap.get(e.target.id)?.classList.toggle('active', e.isIntersecting));
    }, { rootMargin: '-60px 0px -80% 0px', threshold: 0 });
    headings.forEach(h => observer.observe(h));
  }

  document.addEventListener('DOMContentLoaded', buildTOC);
</script>

---
// src/pages/blog/[...slug].astro
import { getCollection, getEntry } from 'astro:content';
import PostLayout from '../../layouts/PostLayout.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);

  return allPosts.map(post => {
    return {
      params: { slug: post.slug },
      props: { post },
    };
  });
}

const { post } = Astro.props;
const { Content } = await post.render();

const wordsPerMinute = 200;
const wordCount = post.body.trim().split(/\s+/).length;
const readingTime = Math.ceil(wordCount / wordsPerMinute);

// Normalize image: local images come back as { src, width, height, ... }, external URLs are plain strings
const imageStr = post.data.image
  ? (typeof post.data.image === 'string' ? post.data.image : post.data.image.src)
  : undefined;

// Determine the parent folder slug
const slugParts = post.slug.split('/');
const parentSlug = slugParts[0];
const isIndex = slugParts.length === 1 || slugParts[1] === 'index';

// Get all posts in same "series" (same parent folder or same single-file)
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const siblings = allPosts.filter(p => p.slug.startsWith(parentSlug + '/') || p.slug === parentSlug);

// Build subpost nav list
const subposts = siblings
  .sort((a, b) => {
    // index first, then alphabetical
    const aIsIndex = a.slug === parentSlug || a.slug.endsWith('/index');
    const bIsIndex = b.slug === parentSlug || b.slug.endsWith('/index');
    if (aIsIndex) return -1;
    if (bIsIndex) return 1;
    return a.slug.localeCompare(b.slug);
  })
  .map(p => {
    const parts = p.slug.split('/');
    const subSlug = parts.length > 1 ? parts[1] : 'index';
    const href = parts.length === 1
      ? `/blog/${p.slug}`
      : p.slug.endsWith('/index')
        ? `/blog/${parts[0]}`
        : `/blog/${p.slug}`;
    return { slug: subSlug, title: p.data.title, href };
  });
---

<PostLayout
  title={post.data.title}
  description={post.data.description}
  date={post.data.date}
  tags={post.data.tags}
  image={imageStr}
  parentSlug={parentSlug}
  currentSlug={post.slug}
  subposts={subposts.length > 1 ? subposts : []}
  readingTime={readingTime}
>
  <Content />
</PostLayout>

---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { PostList } from '../../components/ui/post-list';
import { getCollection } from 'astro:content';

const allPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const topLevelPosts = allPosts.filter(post => {
  const parts = post.slug.split('/');
  return parts.length === 1 || (parts.length === 2 && parts[1] === 'index');
});

const subpostCounts: Record<string, number> = {};
allPosts.forEach(post => {
  const parts = post.slug.split('/');
  if (parts.length === 2 && parts[1] !== 'index') {
    const parent = parts[0];
    subpostCounts[parent] = (subpostCounts[parent] || 0) + 1;
  }
});

const tagCounts: Record<string, number> = {};
topLevelPosts.forEach(post => {
  post.data.tags.forEach(tag => {
    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
  });
});

const allTags = Object.entries(tagCounts)
  .sort((a, b) => b[1] - a[1])
  .map(([tag, count]) => ({ tag, count }));

const postsData = topLevelPosts.map(post => {
  const parentSlug = post.slug.includes('/') ? post.slug.split('/')[0] : post.slug;
  return {
    slug: parentSlug,
    title: post.data.title,
    description: post.data.description,
    date: post.data.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
    tags: post.data.tags,
    image: post.data.image
      ? (typeof post.data.image === 'string' ? post.data.image : post.data.image.src)
      : null,
    subposts: subpostCounts[parentSlug] || 0,
    href: `/blog/${parentSlug}`,
  };
});
---

<BaseLayout title="Blog" description="Security research, CTF writeups, and pentesting notes.">
  <div class="page-container">
    <PostList
      posts={postsData}
      allTags={allTags}
      totalPosts={topLevelPosts.length}
      client:load
    />
  </div>
</BaseLayout>
